{% extends "base.html" %}

{% block title %}Editar Leitura Coletiva - Mesa Liter√°ria{% endblock %}

{% block content %}
<div class="edit-container">
    <div class="page-header">
        <h1>‚úèÔ∏è Editar Leitura Coletiva</h1>
        <h2 class="subtitle">{{ collective.name }}</h2>
    </div>

    {% if error %}
        <div class="alert alert-danger">
            <strong>Erro:</strong> {{ error }}
        </div>
    {% endif %}

    <!-- Se√ß√£o de Datas -->
    <div class="section">
        <h3>üìÖ Datas da Leitura</h3>
        <form method="POST" class="form">
            <input type="hidden" name="action" value="update_dates">
            <div class="form-row">
                <div class="form-group">
                    <label for="start_date">Data de In√≠cio *</label>
                    <input type="date" id="start_date" name="start_date" value="{{ collective.start_date.strftime('%Y-%m-%d') if collective.start_date else '' }}" required>
                </div>
                <div class="form-group">
                    <label for="end_date">Data de T√©rmino *</label>
                    <input type="date" id="end_date" name="end_date" value="{{ collective.end_date.strftime('%Y-%m-%d') if collective.end_date else '' }}" required>
                </div>
            </div>
            <button type="submit" class="btn btn-primary">üíæ Salvar Datas</button>
        </form>
    </div>

    <!-- Livros da Leitura -->
    <div class="section">
        <h3>üìö Livros da Leitura (em sequ√™ncia)</h3>
        
        {% if collective.books %}
            <div class="books-list">
                {% for book in collective.books|sort(attribute='order') %}
                    <div class="book-item" id="book-{{ book.id }}">
                        <!-- Visualiza√ß√£o normal -->
                        <div class="book-view" id="view-{{ book.id }}">
                            <div class="book-cover">
                                {% if book.cover_url %}
                                    <img src="{{ book.cover_url }}" alt="{{ book.title }}" class="cover-image">
                                {% else %}
                                    <div class="cover-placeholder">üìñ</div>
                                {% endif %}
                            </div>
                            <div class="book-info">
                                <h4>#{{ book.order }} - {{ book.title }}</h4>
                                <p>{{ book.total_pages }} p√°ginas</p>
                                <p class="dates">{{ book.start_date.strftime('%d/%m/%Y') }} - {{ book.end_date.strftime('%d/%m/%Y') }}</p>
                            </div>
                            <div class="book-actions">
                                <button onclick="editBook({{ book.id }})" class="btn btn-info btn-small">‚úèÔ∏è Editar</button>
                                <form method="POST" class="book-action-form" onsubmit="return confirm('Remover este livro?');">
                                    <input type="hidden" name="action" value="remove_book">
                                    <input type="hidden" name="book_id" value="{{ book.id }}">
                                    <button type="submit" class="btn btn-danger btn-small">‚ùå Remover</button>
                                </form>
                            </div>
                        </div>
                        
                        <!-- Formul√°rio de edi√ß√£o (oculto) -->
                        <form method="POST" class="book-edit-form" id="edit-{{ book.id }}" style="display:none;">
                            <input type="hidden" name="action" value="edit_book">
                            <input type="hidden" name="book_id" value="{{ book.id }}">
                            
                            <div class="edit-row">
                                <div class="form-group-inline">
                                    <label>Ordem:</label>
                                    <input type="number" name="order" value="{{ book.order }}" min="1" required class="input-small">
                                </div>
                                <div class="form-group-inline flex-1">
                                    <label>T√≠tulo:</label>
                                    <input type="text" name="title" value="{{ book.title }}" required>
                                </div>
                            </div>
                            
                            <div class="edit-row">
                                <div class="form-group-inline">
                                    <label>P√°ginas:</label>
                                    <input type="number" name="total_pages" value="{{ book.total_pages }}" min="1" required class="input-small">
                                </div>
                                <div class="form-group-inline flex-1">
                                    <label>URL Capa:</label>
                                    <input type="url" name="cover_url" value="{{ book.cover_url or '' }}" placeholder="https://...">
                                </div>
                            </div>
                            
                            <div class="edit-row">
                                <div class="form-group-inline flex-1">
                                    <label>Data In√≠cio:</label>
                                    <input type="date" name="start_date" value="{{ book.start_date.strftime('%Y-%m-%d') }}" required>
                                </div>
                                <div class="form-group-inline flex-1">
                                    <label>Data T√©rmino:</label>
                                    <input type="date" name="end_date" value="{{ book.end_date.strftime('%Y-%m-%d') }}" required>
                                </div>
                            </div>
                            
                            <div class="edit-actions">
                                <button type="submit" class="btn btn-success btn-small">üíæ Salvar</button>
                                <button type="button" onclick="cancelEdit({{ book.id }})" class="btn btn-secondary btn-small">‚ùå Cancelar</button>
                            </div>
                        </form>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="empty-message">Nenhum livro adicionado ainda.</p>
        {% endif %}
    </div>

    <!-- Adicionar Novo Livro -->
    <div class="section add-book-section">
        <h3>‚ûï Adicionar Novo Livro</h3>
        <form method="POST" class="form">
            <input type="hidden" name="action" value="add_book">
            
            <div class="form-group">
                <label for="title">T√≠tulo do Livro *</label>
                <input type="text" id="title" name="title" required placeholder="Ex: O Hobbit">
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="total_pages">Total de P√°ginas *</label>
                    <input type="number" id="total_pages" name="total_pages" required min="1" placeholder="297">
                </div>
                <div class="form-group">
                    <label for="cover_url">URL da Capa (Opcional)</label>
                    <input type="url" id="cover_url" name="cover_url" placeholder="https://...">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="start_date_book">Data de In√≠cio *</label>
                    <input type="date" id="start_date_book" name="start_date" required>
                </div>
                <div class="form-group">
                    <label for="end_date_book">Data de T√©rmino *</label>
                    <input type="date" id="end_date_book" name="end_date" required>
                </div>
            </div>

            <div class="form-group info-box">
                <p>
                    <strong>‚ö†Ô∏è Importante:</strong> As datas de cada livro n√£o podem se sobrepor. A sequ√™ncia respeita a ordem de adi√ß√£o.
                </p>
            </div>

            <button type="submit" class="btn btn-success">‚ûï Adicionar Livro</button>
        </form>
    </div>

    <!-- Link de Compartilhamento -->
    <div class="section">
        <h3>üîó Link de Compartilhamento</h3>
        <div class="share-box">
            <input type="text" id="shareLink" value="{{ url_for('main.join_collective_by_hash', share_hash=collective.share_hash, _external=True) }}" readonly class="share-input">
            <button onclick="copyToClipboard()" class="btn btn-primary">üìã Copiar Link</button>
        </div>
        <p class="share-help">Compartilhe este link com seus amigos para que possam participar da leitura!</p>
    </div>

    <!-- Gerenciamento de Moderadores (apenas para o criador) -->
    {% if user.id == collective.creator_id %}
    <div class="section">
        <h3>üë• Moderadores</h3>
        <p class="help-text">Moderadores podem editar livros, datas e configura√ß√µes desta leitura coletiva.</p>
        
        {% if collective.moderators %}
        <div class="moderators-list">
            {% for mod in collective.moderators %}
            <div class="moderator-item">
                <div class="moderator-info">
                    <span class="moderator-name">üë§ {{ mod.user.username }}</span>
                    <span class="moderator-since">desde {{ mod.added_at.strftime('%d/%m/%Y') }}</span>
                </div>
                <button onclick="removeModerator({{ mod.user.id }})" class="btn btn-danger btn-small">‚ùå Remover</button>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="empty-message">Nenhum moderador adicionado ainda.</p>
        {% endif %}
        
        <form onsubmit="addModerator(event)" class="add-moderator-form">
            <div class="form-group">
                <label for="moderator_username">Adicionar Moderador</label>
                <div class="input-button-group">
                    <input type="text" id="moderator_username" name="moderator_username" placeholder="Digite o nome de usu√°rio" required>
                    <button type="submit" class="btn btn-success">‚ûï Adicionar</button>
                </div>
            </div>
        </form>
    </div>
    {% endif %}

    <div class="actions">
        <a href="{{ url_for('main.list_collective') }}" class="btn btn-secondary">‚Üê Voltar</a>
    </div>
</div>

<script>
    function copyToClipboard() {
        const input = document.getElementById('shareLink');
        input.select();
        document.execCommand('copy');
        alert('Link copiado!');
    }
    
    function addModerator(event) {
        event.preventDefault();
        const username = document.getElementById('moderator_username').value;
        
        if (!username.trim()) {
            alert('Por favor, digite um nome de usu√°rio');
            return;
        }
        
        fetch('{{ url_for("main.add_moderator", collective_id=collective.id) }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'username=' + encodeURIComponent(username)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Moderador adicionado com sucesso!');
                location.reload();
            } else {
                alert('Erro: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao adicionar moderador');
        });
    }
    
    function removeModerator(userId) {
        if (!confirm('Tem certeza que deseja remover este moderador?')) {
            return;
        }
        
        fetch('{{ url_for("main.remove_moderator", collective_id=collective.id, moderator_id=0) }}'.replace('/0', '/' + userId), {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Moderador removido com sucesso!');
                location.reload();
            } else {
                alert('Erro: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao remover moderador');
        });
    }
    
    function editBook(bookId) {
        // Ocultar visualiza√ß√£o
        document.getElementById('view-' + bookId).style.display = 'none';
        // Mostrar formul√°rio de edi√ß√£o
        document.getElementById('edit-' + bookId).style.display = 'block';
    }
    
    function cancelEdit(bookId) {
        // Mostrar visualiza√ß√£o
        document.getElementById('view-' + bookId).style.display = 'flex';
        // Ocultar formul√°rio de edi√ß√£o
        document.getElementById('edit-' + bookId).style.display = 'none';
    }
</script>

<style>
    .edit-container {
        max-width: 900px;
        margin: 2rem auto;
    }

    .page-header {
        text-align: center;
        margin-bottom: 2rem;
    }

    .page-header h1 {
        margin: 0;
        font-size: 2rem;
    }

    .page-header .subtitle {
        margin: 0.5rem 0 0 0;
        font-size: 1.3rem;
        color: #666;
    }

    .section {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .section h3 {
        margin-top: 0;
        margin-bottom: 1.5rem;
        font-size: 1.2rem;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
    }

    .form-group input,
    .form-group textarea {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 1rem;
    }

    .books-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .book-item {
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 6px;
        border-left: 4px solid #667eea;
    }
    
    .book-view {
        display: flex;
        gap: 1rem;
        align-items: flex-start;
    }

    .book-cover {
        flex-shrink: 0;
        width: 60px;
        height: 90px;
    }

    .cover-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 4px;
    }

    .cover-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #e0e7ff;
        border-radius: 4px;
        font-size: 2rem;
    }

    .book-info {
        flex: 1;
    }

    .book-info h4 {
        margin: 0 0 0.5rem 0;
    }

    .book-info p {
        margin: 0.25rem 0;
        color: #666;
        font-size: 0.9rem;
    }

    .dates {
        color: #999 !important;
        font-size: 0.85rem !important;
    }

    .book-actions {
        display: flex;
        gap: 0.5rem;
        align-items: flex-start;
    }

    .book-action-form {
        display: inline;
        margin: 0;
    }
    
    .book-edit-form {
        width: 100%;
    }
    
    .edit-row {
        display: flex;
        gap: 1rem;
        margin-bottom: 0.75rem;
    }
    
    .form-group-inline {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }
    
    .form-group-inline.flex-1 {
        flex: 1;
    }
    
    .form-group-inline label {
        font-size: 0.85rem;
        font-weight: 600;
        color: #555;
    }
    
    .form-group-inline input {
        padding: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.9rem;
    }
    
    .input-small {
        width: 80px;
    }
    
    .edit-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .btn-small {
        padding: 0.5rem 1rem;
        font-size: 0.85rem;
    }

    .empty-message {
        color: #999;
        text-align: center;
        padding: 2rem;
    }

    .add-book-section {
        background: #f0f7ff;
        border: 2px solid #bfdbfe;
    }

    .info-box {
        background: white;
        border: 1px solid #e0e7ff;
        padding: 1rem;
        border-radius: 6px;
        margin-bottom: 1rem;
    }

    .info-box p {
        margin: 0;
        color: #333;
    }

    .share-box {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .share-input {
        flex: 1;
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-family: monospace;
        font-size: 0.9rem;
    }

    .share-help {
        color: #666;
        font-size: 0.9rem;
        margin: 0;
    }

    .actions {
        text-align: center;
    }

    .alert {
        padding: 1rem;
        border-radius: 6px;
        margin-bottom: 1.5rem;
    }

    .alert-danger {
        background-color: #fee2e2;
        color: #7f1d1d;
        border: 1px solid #fecaca;
    }

    @media (max-width: 768px) {
        .form-row {
            grid-template-columns: 1fr;
        }

        .book-view {
            flex-direction: column;
        }

        .book-cover {
            width: 80px;
            height: 120px;
        }

        .book-actions {
            flex-direction: row;
            width: 100%;
            gap: 0.75rem;
            margin-top: 0.5rem;
        }

        .book-action-form {
            display: block;
            flex: 1;
            margin: 0;
        }

        .book-actions > button {
            flex: 1;
            margin: 0;
        }

        .book-actions .btn-small {
            width: 100%;
            padding: 0.75rem 0.5rem;
            white-space: nowrap;
        }

        .edit-row {
            flex-direction: column;
        }

        .share-box {
            flex-direction: column;
        }
    }

    /* Estilos para se√ß√£o de moderadores */
    .help-text {
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 1rem;
    }

    .moderators-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
    }

    .moderator-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 6px;
        border-left: 4px solid #667eea;
    }

    .moderator-info {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .moderator-name {
        font-weight: 600;
        font-size: 1rem;
    }

    .moderator-since {
        color: #999;
        font-size: 0.85rem;
    }

    .add-moderator-form {
        margin-top: 1.5rem;
    }

    .input-button-group {
        display: flex;
        gap: 0.5rem;
    }

    .input-button-group input {
        flex: 1;
    }

    @media (max-width: 768px) {
        .moderator-item {
            flex-direction: column;
            align-items: stretch;
            gap: 0.75rem;
        }

        .input-button-group {
            flex-direction: column;
        }

        .input-button-group button {
            width: 100%;
        }
    }
</style>
{% endblock %}
