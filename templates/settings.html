{% extends "base.html" %}

{% block title %}Configura√ß√µes - Mesa Liter√°ria{% endblock %}

{% block content %}
<div class="page-header">
    <h2>‚öôÔ∏è Configura√ß√µes da Conta</h2>
    <p class="subtitle">Gerencie suas prefer√™ncias e seguran√ßa</p>
</div>

{% if success %}
<div class="alert alert-success">
    <strong>‚úì Sucesso!</strong> {{ success }}
</div>
{% endif %}

{% if error %}
<div class="alert alert-danger">
    <strong>‚úó Erro:</strong> {{ error }}
</div>
{% endif %}

<div class="settings-container">
    <!-- Foto de Perfil -->
    <div class="settings-card">
        <h3>üì∑ Foto de Perfil</h3>
        <div class="profile-photo-section">
            <div class="current-photo">
                {% if user.profile_picture %}
                    <img src="{{ user.profile_picture }}" alt="Foto de perfil">
                {% else %}
                    <div class="photo-placeholder">üë§</div>
                {% endif %}
            </div>
            <div class="photo-actions">
                <form method="POST" enctype="multipart/form-data" class="upload-form">
                    <input type="hidden" name="action" value="upload_photo">
                    <div class="file-input-wrapper">
                        <label for="profile_photo" class="btn btn-primary">
                            üì§ Escolher Foto
                        </label>
                        <input type="file" id="profile_photo" name="profile_photo" accept="image/*" onchange="previewImage(this)">
                        <span id="filename" class="filename"></span>
                    </div>
                    <button type="submit" class="btn btn-success" id="uploadBtn" style="display: none;">
                        üíæ Enviar
                    </button>
                </form>
                {% if user.profile_picture %}
                <form method="POST" style="display: inline;">
                    <input type="hidden" name="action" value="remove_photo">
                    <button type="submit" class="btn btn-danger" onclick="return confirm('Tem certeza que deseja remover sua foto?')">
                        üóëÔ∏è Remover Foto
                    </button>
                </form>
                {% endif %}
                <small class="help-text">Formatos aceitos: PNG, JPG, JPEG, GIF, WEBP (m√°x. 5MB)</small>
            </div>
        </div>
    </div>

    <!-- Informa√ß√µes Pessoais -->
    <div class="settings-card">
        <h3>üë§ Informa√ß√µes Pessoais</h3>
        <form method="POST" class="form">
            <input type="hidden" name="action" value="update_profile">
            
            <div class="form-group">
                <label for="username">Nome de Usu√°rio (Login)</label>
                <input type="text" id="username" value="{{ user.username }}" disabled class="disabled-input">
                <small class="help-text">O nome de usu√°rio n√£o pode ser alterado</small>
            </div>

            <div class="form-group">
                <label for="name">Nome Completo</label>
                <input type="text" id="name" name="name" value="{{ user.name or user.username }}" 
                       placeholder="Digite seu nome completo" maxlength="120">
                <small class="help-text">Este nome ser√° exibido em seu perfil p√∫blico</small>
            </div>

            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" value="{{ user.email }}" disabled class="disabled-input">
                <small class="help-text">O email n√£o pode ser alterado</small>
            </div>

            <div class="form-group">
                <label for="reading_speed">Velocidade de Leitura (minutos/p√°gina)</label>
                <input type="number" id="reading_speed" name="reading_speed" 
                       value="{{ user.reading_speed }}" min="0.5" step="0.1" required>
                <small class="help-text">
                    <strong>Exemplos:</strong> Leitura r√°pida (1.5-2.0) ‚Ä¢ Normal (2.5-3.0) ‚Ä¢ Lenta (3.5-4.0)
                </small>
            </div>

            <button type="submit" class="btn btn-primary">üíæ Salvar Altera√ß√µes</button>
        </form>
    </div>

    <!-- Trocar Senha -->
    <div class="settings-card">
        <h3>üîí Seguran√ßa - Trocar Senha</h3>
        <form method="POST" class="form" id="passwordForm">
            <input type="hidden" name="action" value="change_password">
            
            <div class="form-group">
                <label for="old_password">Senha Atual</label>
                <input type="password" id="old_password" name="old_password" required>
            </div>

            <div class="form-group">
                <label for="new_password">Nova Senha</label>
                <input type="password" id="new_password" name="new_password" required>
                <div class="password-strength" id="passwordStrength"></div>
            </div>

            <div class="form-group">
                <label for="new_password_confirm">Confirmar Nova Senha</label>
                <input type="password" id="new_password_confirm" name="new_password_confirm" required>
            </div>

            <div class="password-policy">
                <h4>üìã Pol√≠tica de Senha</h4>
                <ul>
                    <li id="rule-length">M√≠nimo 8 caracteres</li>
                    <li id="rule-uppercase">Pelo menos 1 letra mai√∫scula (A-Z)</li>
                    <li id="rule-lowercase">Pelo menos 1 letra min√∫scula (a-z)</li>
                    <li id="rule-number">Pelo menos 1 n√∫mero (0-9)</li>
                    <li id="rule-special">Pelo menos 1 caractere especial (!@#$%^&*)</li>
                </ul>
            </div>

            <button type="submit" class="btn btn-warning" id="changePasswordBtn">üîê Alterar Senha</button>
        </form>
    </div>

    <!-- Link P√∫blico -->
    <div class="settings-card">
        <h3>üîó Perfil P√∫blico</h3>
        <div class="info-group">
            <label>Link do seu perfil:</label>
            <div class="profile-link-group">
                <input type="text" value="{{ url_for('main.view_profile', user_hash=user.user_hash, _external=True) }}" 
                       id="profileLink" class="profile-link" readonly>
                <button type="button" class="btn btn-primary" onclick="copyProfileLink()">üìã Copiar</button>
            </div>
            <small class="help-text">Compartilhe este link para que outros vejam seus livros p√∫blicos</small>
        </div>
    </div>

    <!-- Informa√ß√µes da Conta -->
    <div class="settings-card info-card">
        <h3>‚ÑπÔ∏è Informa√ß√µes da Conta</h3>
        <div class="info-grid">
            <div class="info-item">
                <span class="label">Membro desde:</span>
                <span class="value">{{ user.created_at.strftime('%d/%m/%Y') }}</span>
            </div>
            <div class="info-item">
                <span class="label">Total de livros:</span>
                <span class="value">{{ user.books|length }}</span>
            </div>
            <div class="info-item">
                <span class="label">Seguidores:</span>
                <span class="value">{{ user.followers|length }}</span>
            </div>
            <div class="info-item">
                <span class="label">Seguindo:</span>
                <span class="value">{{ user.following|length }}</span>
            </div>
        </div>
    </div>
</div>

<script>
    // Preview de imagem
    function previewImage(input) {
        const filename = document.getElementById('filename');
        const uploadBtn = document.getElementById('uploadBtn');
        
        if (input.files && input.files[0]) {
            filename.textContent = input.files[0].name;
            uploadBtn.style.display = 'inline-block';
        } else {
            filename.textContent = '';
            uploadBtn.style.display = 'none';
        }
    }

    // Copiar link do perfil
    function copyProfileLink() {
        const link = document.getElementById('profileLink');
        link.select();
        document.execCommand('copy');
        alert('Link copiado! üìã');
    }

    // Valida√ß√£o de senha em tempo real
    const newPasswordInput = document.getElementById('new_password');
    const confirmPasswordInput = document.getElementById('new_password_confirm');
    const changePasswordBtn = document.getElementById('changePasswordBtn');

    if (newPasswordInput) {
        newPasswordInput.addEventListener('input', function() {
            const password = this.value;
            const strength = document.getElementById('passwordStrength');
            
            // Validar regras
            const rules = {
                length: password.length >= 8,
                uppercase: /[A-Z]/.test(password),
                lowercase: /[a-z]/.test(password),
                number: /\d/.test(password),
                special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
            };
            
            // Atualizar UI das regras
            document.getElementById('rule-length').className = rules.length ? 'valid' : '';
            document.getElementById('rule-uppercase').className = rules.uppercase ? 'valid' : '';
            document.getElementById('rule-lowercase').className = rules.lowercase ? 'valid' : '';
            document.getElementById('rule-number').className = rules.number ? 'valid' : '';
            document.getElementById('rule-special').className = rules.special ? 'valid' : '';
            
            // Calcular for√ßa
            const validCount = Object.values(rules).filter(Boolean).length;
            let strengthText = '';
            let strengthClass = '';
            
            if (validCount === 5) {
                strengthText = 'Senha forte üí™';
                strengthClass = 'strong';
            } else if (validCount >= 3) {
                strengthText = 'Senha m√©dia üëç';
                strengthClass = 'medium';
            } else if (password.length > 0) {
                strengthText = 'Senha fraca ‚ö†Ô∏è';
                strengthClass = 'weak';
            }
            
            strength.textContent = strengthText;
            strength.className = 'password-strength ' + strengthClass;
        });
        
        // Validar confirma√ß√£o de senha
        confirmPasswordInput.addEventListener('input', function() {
            if (this.value !== newPasswordInput.value) {
                this.setCustomValidity('As senhas n√£o conferem');
            } else {
                this.setCustomValidity('');
            }
        });
    }
</script>

<style>
    .settings-container {
        max-width: 800px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }

    .settings-card {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 2rem;
        box-shadow: var(--shadow);
    }

    .settings-card h3 {
        margin: 0 0 1.5rem 0;
        color: var(--text-dark);
        border-bottom: 2px solid var(--primary-color);
        padding-bottom: 0.5rem;
    }

    /* Foto de Perfil */
    .profile-photo-section {
        display: flex;
        gap: 2rem;
        align-items: center;
    }

    .current-photo img,
    .photo-placeholder {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid var(--border-color);
    }

    .photo-placeholder {
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-size: 4rem;
    }

    .photo-actions {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .file-input-wrapper {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .file-input-wrapper input[type="file"] {
        display: none;
    }

    .filename {
        color: var(--text-light);
        font-size: 0.9rem;
    }

    /* Formul√°rios */
    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--text-dark);
    }

    .form-group input[type="text"],
    .form-group input[type="email"],
    .form-group input[type="number"],
    .form-group input[type="password"] {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 1rem;
        transition: border-color 0.2s ease;
    }

    .form-group input:focus {
        outline: none;
        border-color: var(--primary-color);
    }

    .disabled-input {
        background-color: #f3f4f6;
        color: var(--text-light);
        cursor: not-allowed;
    }

    .help-text {
        display: block;
        margin-top: 0.5rem;
        font-size: 0.85rem;
        color: var(--text-light);
    }

    /* Password Strength */
    .password-strength {
        margin-top: 0.5rem;
        padding: 0.5rem;
        border-radius: 4px;
        font-weight: 600;
        text-align: center;
    }

    .password-strength.weak {
        background: #fee;
        color: #c00;
    }

    .password-strength.medium {
        background: #ffc;
        color: #860;
    }

    .password-strength.strong {
        background: #efe;
        color: #060;
    }

    /* Pol√≠tica de Senha */
    .password-policy {
        margin: 1rem 0;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 6px;
        border-left: 4px solid var(--primary-color);
    }

    .password-policy h4 {
        margin: 0 0 0.5rem 0;
        font-size: 0.95rem;
        color: var(--text-dark);
    }

    .password-policy ul {
        margin: 0;
        padding-left: 1.5rem;
        font-size: 0.9rem;
        color: var(--text-light);
    }

    .password-policy li {
        margin: 0.25rem 0;
    }

    .password-policy li.valid {
        color: var(--success-color);
        font-weight: 600;
    }

    .password-policy li.valid::before {
        content: '‚úì ';
    }

    /* Link do Perfil */
    .profile-link-group {
        display: flex;
        gap: 0.5rem;
    }

    .profile-link {
        flex: 1;
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-family: monospace;
        font-size: 0.9rem;
        background: #f8f9fa;
    }

    /* Info Card */
    .info-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .info-card h3 {
        border-bottom-color: rgba(255, 255, 255, 0.3);
        color: white;
    }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
    }

    .info-item {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .info-item .label {
        font-size: 0.85rem;
        opacity: 0.9;
    }

    .info-item .value {
        font-size: 1.5rem;
        font-weight: bold;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .profile-photo-section {
            flex-direction: column;
            text-align: center;
        }

        .file-input-wrapper {
            justify-content: center;
        }

        .profile-link-group {
            flex-direction: column;
        }

        .info-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
</style>
{% endblock %}
